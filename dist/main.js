let global = this;
function initializeSheet() {
}
function postData() {
}
function updateData() {
}
function testPostData() {
}
function testUpdateData() {
}
var x={sheets:[{name:"3-1-1",columns:[{name:"datetime",type:"datetime",threshold:null},{name:"\u5869\u5206\u6FC3\u5EA6",type:"number",threshold:{min:5,max:35}},{name:"DO",type:"number",threshold:{target:8,tolerance:10}},{name:"\u6C34\u6E29",type:"number",threshold:{min:0,max:40}},{name:"\u5916\u6C17\u6E29",type:"number",threshold:{target:20,tolerance:5}}]},{name:"3-1-2",columns:[{name:"datetime",type:"datetime",threshold:null},{name:"\u5869\u5206\u6FC3\u5EA6",type:"number",threshold:{min:5,max:35}},{name:"DO",type:"number",threshold:{target:8,tolerance:10}},{name:"\u6C34\u6E29",type:"number",threshold:{min:0,max:40}},{name:"\u5916\u6C17\u6E29",type:"number",threshold:{target:20,tolerance:5}}]}]};var u="1ikEvU2I88BuvYGxegNe8dLsQlcU-POjN7vlIUK4Bf7o";function D(){let r=SpreadsheetApp.openById(u);x.sheets.forEach(e=>{let t=r.getSheetByName(e.name);t||(t=r.insertSheet(e.name)),t.clear();let s=e.columns.map(a=>a.name);t.getRange(1,1,1,s.length).setValues([s])}),Logger.log("\u30B7\u30FC\u30C8\u306E\u4F5C\u6210\u30FB\u66F4\u65B0\u304C\u5B8C\u4E86\u3057\u307E\u3057\u305F\u3002")}function h(r,e){let s=SpreadsheetApp.openById(r).getSheetByName(e);if(!s)throw new Error(`\u30B7\u30FC\u30C8 '${e}' \u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093`);return s}function p(r){try{let e=JSON.parse(r),t=e.sheetName,s=e.data;if(!t||!s)return{success:!1,message:"Invalid request: sheetName and data are required."};let a=h(u,t);if(!a)return{success:!1,message:`Error: Sheet '${t}' not found.`};let i=a.getRange(1,1,1,a.getLastColumn()).getValues()[0],n=Object.keys(s);if(!k(n,i))return{success:!1,message:`Error: Request data keys do not match sheet headers. Expected keys: ${i.join(", ")}, but received: ${n.join(", ")}`};let m=i.map(l=>s[l]??"");return a.appendRow(m),{success:!0,message:"\u30C7\u30FC\u30BF\u3092\u8FFD\u52A0\u3057\u307E\u3057\u305F\u3002"}}catch(e){return{success:!1,message:`Error: ${e instanceof Error?e.message:"An unknown error occurred."}`}}}function k(r,e){return r.length!==e.length?!1:r.every((t,s)=>t===e[s])}function R(){let r=JSON.stringify({sheetName:"3-1-1",data:{datetime:"2024-02-25 11:00:00",\u5869\u5206\u6FC3\u5EA6:"2024-02-25 11:00:00",DO:8.4,\u6C34\u6E29:2,\u5916\u6C17\u6E29:2}}),e=p(r);Logger.log(e)}function f(r){try{let e=JSON.parse(r),t=e.sheetName,s=e.searchKeys,a=e.updateValues;if(console.log("searchKeys",s),console.log("updateValues",a),!t||!s||!a)return{success:!1,message:"Invalid request: sheetName, searchKeys, and updateValues are required."};let i=h(u,t);if(!i)return{success:!1,message:`Error: Sheet '${t}' not found.`};let n=i.getRange(1,1,1,i.getLastColumn()).getValues()[0],m=Object.keys(s);if(!m.every(o=>n.includes(o)))return{success:!1,message:`Error: Some search criteria keys do not exist in sheet headers. Expected keys: ${n.join(", ")}, but received: ${m.join(", ")}`};let l=Object.keys(a);if(!l.every(o=>n.includes(o)))return{success:!1,message:`Error: Some update values keys do not exist in sheet headers. Expected keys: ${n.join(", ")}, but received: ${l.join(", ")}`};let y=i.getDataRange().getValues().slice(1);console.log("dataRows",y);let d=y.map((o,c)=>({row:o.map((g,N)=>{let S=n[N];return S==="datetime"&&g instanceof Date||S==="\u5869\u5206\u6FC3\u5EA6"&&g instanceof Date?Utilities.formatDate(g,Session.getScriptTimeZone(),"yyyy-MM-dd HH:mm:ss"):g}),index:c+2})).filter(({row:o})=>m.every(c=>String(o[n.indexOf(c)])===String(s[c])));if(console.log("matchingRows",d),d.length===0)return{success:!1,message:"Error: No matching records found for the given criteria."};if(d.length>1)return{success:!1,message:"Error: Multiple records match the given criteria. Please provide more specific search criteria."};let E=d[0].index;return l.forEach(o=>{let c=n.indexOf(o);i.getRange(E,c+1).setValue(a[o])}),{success:!0,message:"Data successfully updated."}}catch(e){return{success:!1,message:`Error: ${e instanceof Error?e.message:"An unknown error occurred."}`}}}function b(){let r=JSON.stringify({sheetName:"3-1-1",searchKeys:{datetime:"2024-02-25 12:00:00",\u5916\u6C17\u6E29:3},updateValues:{DO:9.1,\u6C34\u6E29:25}}),e=f(r);Logger.log(e)}global.initializeSheet=D;global.postData=p;global.updateData=f;global.testPostData=R;global.testUpdateData=b;
